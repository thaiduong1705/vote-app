generator client {
  provider = "prisma-client"
  output   = "./generated"
  moduleFormat  = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum ROOM_STATUS {
  ACTIVE
  CLOSED
}

enum PARTICIPANT_ROLE {
  HOST
  GUEST
}

model Rooms {
  id                    String        @id @default(uuid())
  roomName             String
  startAt              DateTime
  endAt                DateTime
  status                ROOM_STATUS   @default(ACTIVE)
  ownerId             String        // participant id
  winnerRestaurantId  String?
  createdAt           DateTime      @default(now())

  participants          Participants[]
  invitations           Invitations[]
  votes                 Votes[]
  winner                Restaurants?   @relation("WinnerRestaurant", fields: [winnerRestaurantId], references: [id])

  @@index([status, endAt])
}

model Participants {
  id                String             @id @default(uuid())
  roomId           String
  email             String
  role              PARTICIPANT_ROLE   @default(GUEST)
  joinedAt         DateTime           @default(now())

  room              Rooms              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  votes             Votes[]

  @@unique([roomId, email])
  @@index([roomId])
}

model Invitations {
  id          String    @id @default(uuid())
  roomId     String
  email       String
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  room        Rooms     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, email])
  @@index([roomId, email])
}

model Restaurants {
  id              String   @id @default(uuid())
  name            String   @unique
  createdAt      DateTime @default(now())

  votes           Votes[]
  winnerRooms    Rooms[]  @relation("WinnerRestaurant")
}

model Votes {
  id                 String       @id @default(uuid())
  roomId            String
  participantId     String
  participantEmail  String
  restaurantId      String
  votedAt           DateTime     @default(now())
  room               Rooms        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  participant        Participants @relation(fields: [participantId], references: [id], onDelete: Cascade)
  restaurant         Restaurants  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([roomId, participantId])
  @@index([roomId])
}