generator client {
  provider = "prisma-client"
  output   = "./generated"
  moduleFormat  = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum ROOM_STATUS {
  ACTIVE
  CLOSED
}

enum PARTICIPANT_ROLE {
  HOST
  GUEST
}

model Rooms {
  id                    String        @id @default(uuid())
  room_name             String
  start_at              DateTime
  end_at                DateTime
  status                ROOM_STATUS   @default(ACTIVE)
  owner_id              String        // participant id
  winner_restaurant_id  String?
  created_at            DateTime      @default(now())

  participants          Participants[]
  invitations           Invitations[]
  votes                 Votes[]
  winner                Restaurants?   @relation("WinnerRestaurant", fields: [winner_restaurant_id], references: [id])

  @@index([status, end_at])
}

model Participants {
  id                String             @id @default(uuid())
  room_id           String
  email             String
  role              PARTICIPANT_ROLE   @default(GUEST)
  joined_at         DateTime           @default(now())

  room              Rooms              @relation(fields: [room_id], references: [id], onDelete: Cascade)
  votes             Votes[]

  @@unique([room_id, email])
  @@index([room_id])
}

model Invitations {
  id          String    @id @default(uuid())
  room_id     String
  email       String
  expires_at  DateTime
  used_at     DateTime?
  created_at  DateTime  @default(now())

  room        Rooms     @relation(fields: [room_id], references: [id], onDelete: Cascade)

  @@unique([room_id, email])
  @@index([room_id, email])
}

model Restaurants {
  id              String   @id @default(uuid())
  name            String   @unique
  menu_image_url  String?
  created_at      DateTime @default(now())

  votes           Votes[]
  winner_rooms    Rooms[]  @relation("WinnerRestaurant")
}

model Votes {
  id                 String       @id @default(uuid())
  room_id            String
  participant_id     String
  participant_email  String
  restaurant_id      String
  voted_at           DateTime     @default(now())

  room               Rooms        @relation(fields: [room_id], references: [id], onDelete: Cascade)
  participant        Participants @relation(fields: [participant_id], references: [id], onDelete: Cascade)
  restaurant         Restaurants  @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)

  @@unique([room_id, participant_id])
  @@index([room_id])
}